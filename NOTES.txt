# AudIn - AI-Powered Email & Calendar Digest

## üéØ Project Overview
AudIn transforms unread emails and calendar events into a daily personalized podcast-style audio digest (under 2 minutes). Built with Next.js App Router, it offers both OAuth integration with Gmail/Calendar and a demo mode with editable sample data.

## üèóÔ∏è Architecture

### Frontend (Next.js App Router)
- **Landing Page** (`/`): Features overview, "Connect Gmail" (OAuth) or "Try Demo" options
- **Dashboard** (`/dashboard`): Main UI for digest generation, audio playback, demo data editing, voice selection
- **Components**: SessionProvider, DemoDataEditor (expandable), VoiceSelector (ElevenLabs only)

### Backend (API Routes)
- `/api/generate-digest`: Handles both demo and OAuth digest generation
- `/api/tts-status`: Returns active TTS provider status
- `/api/auth/[...nextauth]`: NextAuth.js OAuth configuration

### AI Pipeline (Two-Stage GPT Process)
1. **GPT Call 1** (`processEmailsToJSON`): 
   - Model: `gpt-3.5-turbo` with JSON mode
   - Input: Cleaned email content (max 200 chars per email)
   - Output: Structured JSON with urgency scores (1-10), categories, concise summaries
   - Temperature: 0.1 for consistency

2. **GPT Call 2** (`generatePodcastScript`):
   - Model: `gpt-3.5-turbo` 
   - Input: Sorted email summaries + calendar events
   - Output: 1-2 minute podcast script with prosody markers
   - Temperature: 0.6 for natural flow

### Text-to-Speech
- **Primary**: ElevenLabs API (if `ELEVEN_LABS_KEY` provided) with 6 curated human voices
- **Fallback**: OpenAI TTS-1-HD with "nova" voice
- **Preprocessing**: Converts `[PAUSE:long]` ‚Üí `\n\n`, `[PAUSE:short]` ‚Üí `,`, `*word*` ‚Üí `‚Äî word ‚Äî`

## üîß Key Technical Details

### Email Processing & Token Optimization
- **Scope**: Unread emails from Gmail "Primary" tab, last 3 days, max 8 emails
- **Content Cleaning** (`cleanEmailContent`): Removes signatures, footers, reply chains, HTML
- **Character Limits**: 200 chars max per email after cleaning (early truncation at 3000‚Üí1000 chars)
- **Debug Logging**: Extensive logging for content cleaning effectiveness and GPT inputs

### OAuth Integration
- **Provider**: Google OAuth 2.0 via NextAuth.js
- **Scopes**: `gmail.readonly`, `calendar.readonly`, `userinfo.email`, `userinfo.profile`
- **APIs**: Gmail API (Primary tab filtering), Google Calendar API (today's events)

### Demo Mode Features
- **Sample Data**: 5 mock emails, 3 calendar events
- **Presets**: "Default", "Busy Day", "Light Day", "Crisis Mode"
- **Editable**: Expandable section on dashboard for custom demo data
- **Session Storage**: Preserves demo state and voice selection

## üìÅ Key Files & Functions

### Core Logic
- `src/lib/openai.ts`: Two-stage GPT pipeline with detailed prompts
- `src/lib/emailProcessor.ts`: Advanced email cleaning (`cleanEmailContent`)
- `src/lib/ttsProviders.ts`: Dynamic TTS provider selection
- `src/lib/digestGenerator.ts`: OAuth digest orchestration
- `src/lib/aiPipeline.ts`: Main digest generation coordinator

### Data & Types
- `src/types/`: TypeScript interfaces for email, calendar, digest data
- `src/data/`: Mock data and demo presets
- `src/lib/elevenLabsVoices.ts`: Curated human-like voices

### UI Components
- `src/app/page.tsx`: Landing with OAuth/demo options
- `src/app/dashboard/page.tsx`: Main dashboard with session handling
- `src/components/DemoDataEditor.tsx`: Expandable demo data editor
- `src/components/VoiceSelector.tsx`: ElevenLabs voice selection

## ‚ö†Ô∏è Common Issues & Solutions

### Token Limit Errors
- **Problem**: GPT context length exceeded (16,385 tokens)
- **Solutions Applied**: Limited to 8 emails, Primary tab only, aggressive content cleaning
- **Current Limits**: 200 chars per email body, 3-day window

### OAuth Setup
- **Redirect URI**: Must be `http://localhost:3000/api/auth/callback/google`
- **Test Users**: Add email to Google Cloud Console test users list
- **Required APIs**: Gmail API, Google Calendar API

### GPT Output Quality
- **Repetitive Summaries**: Updated prompts with explicit length rules and "NO REPETITION"
- **Simple vs Complex**: Clear examples in prompt (simple = 1 sentence, complex = 2-3)
- **Urgency Scoring**: 1-10 scale with detailed criteria in prompt

## üîë Environment Variables
```
OPENAI_API_KEY=sk-...
ELEVEN_LABS_KEY=... (optional, enables premium TTS)
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=http://localhost:3000
```

## üéµ Audio Generation Flow
1. Fetch emails/calendar ‚Üí Clean content ‚Üí GPT summarization ‚Üí GPT script generation
2. Preprocess script (convert pause markers) ‚Üí TTS generation ‚Üí Base64 encoding
3. Frontend audio player with generated MP3

## üìä Current Status
- ‚úÖ Full OAuth integration with Gmail/Calendar
- ‚úÖ Advanced email content cleaning and token optimization
- ‚úÖ Two-stage AI pipeline with refined prompts
- ‚úÖ ElevenLabs integration with voice selection
- ‚úÖ Demo mode with editable presets
- ‚úÖ Responsive UI with session management

## üîÑ Development Approach
"Frontend First, OAuth Later" - UI built first with mock data, then OAuth integration added. Extensive iterative refinement of AI prompts based on real-world email testing.
